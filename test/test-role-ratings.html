<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Ratings Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .recruit-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>GD Recruit Extension - Role Ratings Test</h1>
    
    <div class="test-section info">
        <h2>Test Overview</h2>
        <p>This page tests the role ratings functionality of the GD Recruit Extension.</p>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="test-results"></div>

    <script type="module">
        // Import the calculator module for testing
        import * as calculator from '../lib/calculator.js';
        
        // Test data
        const testRecruit = {
            recruit_id: 'test-recruit-1',
            position: 'QB',
            stats: {
                accuracy: 85,
                arm_strength: 90,
                intelligence: 80,
                leadership: 88,
                speed: 75,
                agility: 78,
                toughness: 82
            }
        };

        const customRoleRatings = {
            "QB": {
                "Pocket_Passer": {
                    "accuracy": 30,
                    "arm_strength": 25,
                    "intelligence": 20,
                    "leadership": 15,
                    "speed": 5,
                    "agility": 5
                },
                "Dual_Threat": {
                    "accuracy": 20,
                    "arm_strength": 15,
                    "intelligence": 15,
                    "leadership": 10,
                    "speed": 20,
                    "agility": 20
                }
            }
        };

        let testResults = [];

        // Test functions
        async function testLoadDefaultRoleRatings() {
            try {
                const ratings = await calculator.loadRoleRatings();
                const hasQB = ratings && ratings.QB;
                const hasPocketPasser = hasQB && ratings.QB.Pocket_Passer;
                
                return {
                    name: 'Load Default Role Ratings',
                    success: hasQB && hasPocketPasser,
                    message: hasQB && hasPocketPasser 
                        ? 'Successfully loaded default role ratings'
                        : 'Failed to load default role ratings structure',
                    data: ratings ? Object.keys(ratings).slice(0, 3) : null
                };
            } catch (error) {
                return {
                    name: 'Load Default Role Ratings',
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function testCalculateRoleRating() {
            try {
                await calculator.loadRoleRatings(); // Ensure ratings are loaded
                const rating = await calculator.calculateRoleRating(testRecruit, 'QB', 'Pocket_Passer');
                
                return {
                    name: 'Calculate Role Rating',
                    success: typeof rating === 'number' && rating > 0 && rating <= 100,
                    message: typeof rating === 'number' 
                        ? `Calculated rating: ${rating.toFixed(2)}`
                        : 'Failed to calculate valid rating',
                    data: { recruit: testRecruit.recruit_id, position: 'QB', role: 'Pocket_Passer', rating }
                };
            } catch (error) {
                return {
                    name: 'Calculate Role Rating',
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function testSaveAndLoadCustomRatings() {
            try {
                // Save custom ratings
                await calculator.saveRoleRatings(customRoleRatings);
                
                // Load them back
                const loadedRatings = await calculator.getCurrentRoleRatings();
                const hasCustomQB = loadedRatings && loadedRatings.QB && loadedRatings.QB.Pocket_Passer;
                const correctAccuracy = hasCustomQB && loadedRatings.QB.Pocket_Passer.accuracy === 30;
                
                return {
                    name: 'Save and Load Custom Ratings',
                    success: hasCustomQB && correctAccuracy,
                    message: hasCustomQB && correctAccuracy
                        ? 'Successfully saved and loaded custom ratings'
                        : 'Failed to save/load custom ratings correctly',
                    data: loadedRatings ? { QB_Pocket_Passer_accuracy: loadedRatings.QB?.Pocket_Passer?.accuracy } : null
                };
            } catch (error) {
                return {
                    name: 'Save and Load Custom Ratings',
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function testRecalculateRoleRatings() {
            try {
                const testRecruits = [testRecruit, {
                    recruit_id: 'test-recruit-2',
                    position: 'RB',
                    stats: {
                        speed: 90,
                        agility: 85,
                        power: 80,
                        toughness: 75,
                        vision: 82
                    }
                }];

                const results = await calculator.recalculateRoleRatings(testRecruits);
                const hasResults = results && results.length > 0;
                const hasRoleRatings = hasResults && results[0].role_ratings;
                
                return {
                    name: 'Recalculate Role Ratings',
                    success: hasResults && hasRoleRatings,
                    message: hasResults && hasRoleRatings
                        ? `Recalculated ratings for ${results.length} recruits`
                        : 'Failed to recalculate role ratings',
                    data: hasRoleRatings ? Object.keys(results[0].role_ratings) : null
                };
            } catch (error) {
                return {
                    name: 'Recalculate Role Ratings',
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function testResetToDefaults() {
            try {
                // First save custom ratings
                await calculator.saveRoleRatings(customRoleRatings);
                
                // Reset to defaults
                await calculator.resetRoleRatingsToDefaults();
                
                // Load and verify defaults
                const defaultRatings = await calculator.getCurrentRoleRatings();
                const hasDefaults = defaultRatings && defaultRatings.QB && defaultRatings.QB.Pocket_Passer;
                const isDefault = hasDefaults && defaultRatings.QB.Pocket_Passer.accuracy !== 30; // Should not be our custom value
                
                return {
                    name: 'Reset to Defaults',
                    success: hasDefaults && isDefault,
                    message: hasDefaults && isDefault
                        ? 'Successfully reset to default ratings'
                        : 'Failed to reset to default ratings',
                    data: hasDefaults ? { QB_Pocket_Passer_accuracy: defaultRatings.QB.Pocket_Passer.accuracy } : null
                };
            } catch (error) {
                return {
                    name: 'Reset to Defaults',
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function testValidationAndErrorHandling() {
            try {
                let errors = [];
                
                // Test invalid recruit
                try {
                    await calculator.calculateRoleRating(null, 'QB', 'Pocket_Passer');
                    errors.push('Should have failed for null recruit');
                } catch (e) {
                    // Expected error
                }
                
                // Test invalid position
                try {
                    await calculator.calculateRoleRating(testRecruit, 'INVALID', 'Pocket_Passer');
                    errors.push('Should have failed for invalid position');
                } catch (e) {
                    // Expected error
                }
                
                // Test invalid role
                try {
                    await calculator.calculateRoleRating(testRecruit, 'QB', 'INVALID_ROLE');
                    errors.push('Should have failed for invalid role');
                } catch (e) {
                    // Expected error
                }
                
                return {
                    name: 'Validation and Error Handling',
                    success: errors.length === 0,
                    message: errors.length === 0
                        ? 'All validation tests passed correctly'
                        : `Validation errors: ${errors.join(', ')}`,
                    data: { error_count: errors.length }
                };
            } catch (error) {
                return {
                    name: 'Validation and Error Handling',
                    success: false,
                    message: `Unexpected error: ${error.message}`,
                    data: null
                };
            }
        }

        // Test runner
        async function runAllTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="test-section info"><h3>Running Tests...</h3></div>';
            
            testResults = [];
            
            const tests = [
                testLoadDefaultRoleRatings,
                testCalculateRoleRating,
                testSaveAndLoadCustomRatings,
                testRecalculateRoleRatings,
                testResetToDefaults,
                testValidationAndErrorHandling
            ];
            
            for (const test of tests) {
                try {
                    const result = await test();
                    testResults.push(result);
                    displayTestResult(result);
                    await new Promise(resolve => setTimeout(resolve, 100)); // Small delay between tests
                } catch (error) {
                    const errorResult = {
                        name: test.name || 'Unknown Test',
                        success: false,
                        message: `Test execution error: ${error.message}`,
                        data: null
                    };
                    testResults.push(errorResult);
                    displayTestResult(errorResult);
                }
            }
            
            displaySummary();
        }

        function displayTestResult(result) {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-section ${result.success ? 'success' : 'error'}`;
            
            testDiv.innerHTML = `
                <h3>${result.name} - ${result.success ? 'PASSED' : 'FAILED'}</h3>
                <p>${result.message}</p>
                ${result.data ? `<pre>${JSON.stringify(result.data, null, 2)}</pre>` : ''}
            `;
            
            resultsDiv.appendChild(testDiv);
        }

        function displaySummary() {
            const resultsDiv = document.getElementById('test-results');
            const passed = testResults.filter(r => r.success).length;
            const total = testResults.length;
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-section ${passed === total ? 'success' : 'error'}`;
            summaryDiv.innerHTML = `
                <h2>Test Summary</h2>
                <p><strong>${passed}/${total} tests passed</strong></p>
                <p>Success Rate: ${((passed/total)*100).toFixed(1)}%</p>
            `;
            
            resultsDiv.appendChild(summaryDiv);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            testResults = [];
        }

        // Make functions available globally
        window.runAllTests = runAllTests;
        window.clearResults = clearResults;
    </script>
</body>
</html>
